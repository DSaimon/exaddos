<html>
	<head>
		<style type="text/css">
			h1 {
				font-size: 15px;
			}

			.warning-true {
				background-color: #FF2070;
			}

			.warning-false {
			}

			#error {
				display: inline-block;
				text-align: center;
				width: 100%;
			}

			.error-true {
				color: #901030;
			}

			#speaker_pckts {
			}

			#speaker_bytes {
			}

			#speaker_flows {
			}

			#listener_pckts {
			}

			#listener_bytes {
			}

			#listener_flows {
			}

			table.large {
				padding: 0px
				border: 1px solid black;
				width:  910px;
				font-size: 12px;
			}

			table.large thead tr td {
				border-bottom: 1px solid black;
				padding: 0px
			}

			table.large thead tr td{
				background: #C6C6E6;
				padding: 5px;
				min-width: 100px;
			}

			table.large tbody tr:nth-child(even) td{
				background: #E6E6E6;
			}

			table.small {
				padding: 0px
				border: 1px solid black;
				width:  304px;
				font-size: 12px;
				float:left;
			}

			table.small thead tr td {
				border-bottom: 1px solid black;
				padding: 0px
			}

			table.small thead tr td{
				background: #C6C6E6;
				padding: 5px;
				min-width: 100px;
			}

			table.small tbody tr:nth-child(even) td{
				background: #E6E6E6;
			}


		</style>

		<script type="text/javascript" src="/inc/jquery-1.10.2.js"></script>
		<script type="text/javascript" src="/inc/jquery.tmpl.min.js"></script>
		<!-- <script type="text/javascript" src="https://www.google.com/jsapi"></script> -->

		<script type="text/javascript">
				function draw_error (message) {
					$("#error").html("<span class='error-true'>"+message+"</span>");
				}

				// console.log(response);
				// Only if the data is not returned as 'text/json' otherwise the browser does it for us
				// draw_table(jQuery.parseJSON(response));

				function fetch_interfaces(json_address){
					$.ajax({
						type: "GET",
						url: json_address,
						success: function (response) {
							$("#snmp_container").empty();
							for (var key in response) {
								var values = response[key];
								values['link'] = key;
								$("#snmp_template").tmpl(values).appendTo("#snmp_container");
							}
						},
						error: function (XMLHttpRequest, textStatus, errorThrown) {
							draw_error('we lost our connection to our snmp data source');
						}
					});
				}

				function fetch_stat(json_address){
					$.ajax({
						type: "GET",
						url: json_address,
						success: function (response) {
							var counter = ["pckts","bytes","flows"];
							var proto = ["udp","tcp","other","total"];
							var view = [];

							if (jQuery.isEmptyObject(response)) {
								for (var p in proto) {
									response[proto[p]] = new Array();
									for (var c in counter) {
										response[proto[p]][counter[c]] = 0;
									}
								}
							}

							var presentation = new Array();
							presentation['pckts'] = 'Packets';
							presentation['bytes'] = 'Bytes';
							presentation['flows'] = 'Flows';

							$("#stat_container").empty();
							for (var c in counter) {
								var data = new Array();
								data['counter'] = presentation[counter[c]];
								for (var p in proto) {
									data[proto[p]] = response[proto[p]][counter[c]];
								}
								view[c] = data;
							}
							$("#stat_template").tmpl(view).appendTo("#stat_container");
						},
						error: function (XMLHttpRequest, textStatus, errorThrown) {
							draw_error('we lost our connection to our flow data source');
						}
					});
				}

				function fetch_talker(json_address,what,counter){
					$.ajax({
						type: "GET",
						url: json_address,
						success: function (response) {
							var destination = ["sipv4","dipv4","sport","dport"];
							var counter = ["pckts","bytes","flows"];

							for (var d in destination) {
								for (var c in counter) {
									$("#"+destination[d]+"_"+counter[c]+"_container").empty();
									$("#talker_template").tmpl(response[destination[d]][counter[c]]).appendTo("#"+destination[d]+"_"+counter[c]+"_container");
								}
							}
						},
						error: function (XMLHttpRequest, textStatus, errorThrown) {
							draw_error('we lost our connection to our snmp data source');
						}
					});
				}

			$(document).ready(function() {
				fetch_interfaces('/json/snmp/interfaces.json');
				fetch_stat('/json/flow/overview.json');
				fetch_talker('/json/flow/traffic.json');
			});

			window.setInterval(function(){
				fetch_interfaces('/json/snmp/interfaces.json');
				fetch_stat('/json/flow/overview.json');
				fetch_talker('/json/flow/traffic.json');
			}, 1000);

			window.setInterval(function(){
				$("#error").empty();
			}, 3000);

		</script>

		<script id="snmp_error" type="text/x-jquery-tmpl">
			<tr>
				<td colspan="8">connection to server lost</td>
			</tr>
		</script>

		<script id="stat_template" type="text/x-jquery-tmpl">
			<tr id="${link}">
				<td align='center'>${counter}</td>
				<td align='right'>${udp}</td>
				<td align='right'>${tcp}</td>
				<td align='right'>${other}</td>
				<td align='right'>${total}</td>
			</tr>
		</script>

		<script id="snmp_template" type="text/x-jquery-tmpl">
			<tr id="${link}">
				<td class='warning-${warning}'>${link}</td>
				<td class='warning-${warning}'>${description}</td>
				<td class='warning-${warning}' align='right'>${ifHCInOctets}</td>
				<td class='warning-${warning}' align='right'>${ifHCInUcastPkts}</td>
				<td class='warning-${warning}' align='right'>${ifInNUcastPkts}</td>
				<td class='warning-${warning}' align='right'>${ifInDiscards}</td>
				<td class='warning-${warning}' align='right'>${ifInErrors}</td>
				<td class='warning-${warning}' align='right'>${duration}</td>
			</tr>
		</script>

		<script id="talker_template" type="text/x-jquery-tmpl">
			<tr onclick="window.open('/view/${key}.html')">
				<td align='left'>${key}</td>
				<td align='right'>${value}</td>
			</tr>
		</script>

	</head>

	<body>
		<div id='error'></div>

		<h1>SNMP</h1>

		<table class='large' id='snmp'>
			<thead>
				<tr>
					<td align='center'>Node</td>
					<td align='center'>Location</td>
					<td align='center'>Bandwidth</td>
					<td align='center'>Unicast</td>
					<td align='center'>NonUnicast</td>
					<td align='center'>Drop</td>
					<td align='center'>Error</td>
					<td align='center'>Query Time</td>
				</tr>
			</thead>
			<tbody id='snmp_container'>
			</tbody>
		</table>

		<h1>FLOW</h1>

		<table class='large' id='stat'>
			<thead>
				<tr>
					<td align='center'>Counter</td>
					<td align='center'>UDP</td>
					<td align='center'>TCP</td>
					<td align='center'>ICMP</td>
					<td align='center'>Total</td>
				</tr>
			</thead>
			<tbody id='stat_container'>
			</tbody>
		</table>

		<table class='small' id='sipv4_pckts'>
			<thead>
				<tr>
					<td align='center'>Src IP</td>
					<td align='center'>Packets</td>
				</tr>
			</thead>
			<tbody id='sipv4_pckts_container'>
			</tbody>
		</table>

		<table class='small' id='sipv4_bytes'>
			<thead>
				<tr>
					<td align='center'>Src IP</td>
					<td align='center'>Bandwidth</td>
				</tr>
			</thead>
			<tbody id='sipv4_bytes_container'>
			</tbody>
		</table>

		<table class='small' id='sipv4_flows'>
			<thead>
				<tr>
					<td align='center'>Src IP</td>
					<td align='center'>Flows</td>
				</tr>
			</thead>
			<tbody id='sipv4_flows_container'>
			</tbody>
		</table>

		<br style='clear:both' />

		<table class='small' id='dipv4_pckts'>
			<thead>
				<tr>
					<td align='center'>Dst IP</td>
					<td align='center'>Packets</td>
				</tr>
			</thead>
			<tbody id='dipv4_pckts_container'>
			</tbody>
		</table>

		<table class='small' id='dipv4_bytes'>
			<thead>
				<tr>
					<td align='center'>Dst IP</td>
					<td align='center'>Bandwidth</td>
				</tr>
			</thead>
			<tbody id='dipv4_bytes_container'>
			</tbody>
		</table>

		<table class='small' id='dipv4_flows'>
			<thead>
				<tr>
					<td align='center'>Dst IP</td>
					<td align='center'>Flows</td>
				</tr>
			</thead>
			<tbody id='dipv4_flows_container'>
			</tbody>
		</table>

		<br style='clear:both' />

		<table class='small' id='sport_pckts'>
			<thead>
				<tr>
					<td align='center'>Src Port</td>
					<td align='center'>Packets</td>
				</tr>
			</thead>
			<tbody id='sport_pckts_container'>
			</tbody>
		</table>

		<table class='small' id='sport_bytes'>
			<thead>
				<tr>
					<td align='center'>Src Port</td>
					<td align='center'>Bandwidth</td>
				</tr>
			</thead>
			<tbody id='sport_bytes_container'>
			</tbody>
		</table>

		<table class='small' id='sport_flows'>
			<thead>
				<tr>
					<td align='center'>Src Port</td>
					<td align='center'>Flows</td>
				</tr>
			</thead>
			<tbody id='sport_flows_container'>
			</tbody>
		</table>

		<br style='clear:both' />

		<table class='small' id='dport_pckts'>
			<thead>
				<tr>
					<td align='center'>Dst Port</td>
					<td align='center'>Packets</td>
				</tr>
			</thead>
			<tbody id='dport_pckts_container'>
			</tbody>
		</table>

		<table class='small' id='dport_bytes'>
			<thead>
				<tr>
					<td align='center'>Dst Port</td>
					<td align='center'>Bandwidth</td>
				</tr>
			</thead>
			<tbody id='dport_bytes_container'>
			</tbody>
		</table>

		<table class='small' id='dport_flows'>
			<thead>
				<tr>
					<td align='center'>Dst Port</td>
					<td align='center'>Flows</td>
				</tr>
			</thead>
			<tbody id='dport_flows_container'>
			</tbody>
		</table>

	</body>
</html>
